{% extends 'base/layouts/base.html' %}

{% block page_header %}Log Detail{% endblock %}

{% block breadcrumbs %}
    <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
    <li class="breadcrumb-item active">Log Details</li>
{% endblock %}

{% block content %}
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="card-title mb-0">{{ object.name }}</h5>
        </div>
        <div class="card-body">
            <p>Path: {{ object.path }}</p>
            <div id="log-box"
                 class="bg-black text-white py-2 px-3 font-monospace overflow-y-auto overflow-x-auto"
                 style="height: 600px;">
                {% for line in lines %}
                    <div>{{ line }}</div>
                {% endfor %}
            </div>
            <button id="jump-btn"
                    class="btn btn-primary position-absolute"
                    style="bottom: 10px; right: 10px; display: none;">
                Jump to bottom
            </button>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const logBox = document.getElementById("log-box");
        const jumpBtn = document.getElementById("jump-btn");
        let logBoxLines = {{ lines|length }};

        // Auto-scroll to bottom on page load
        logBox.scrollTop = logBox.scrollHeight;

        function isNearBottom(el, threshold = 50) {
            return el.scrollHeight - el.scrollTop - el.clientHeight < threshold;
        }

        function appendLog(line) {
            // Create a new div for the log line
            const lineEl = document.createElement("div");
            lineEl.textContent = line; // safe from HTML injection
            logBox.appendChild(lineEl);

            // Remove old logs past 500
            logBoxLines++;
            if (logBoxLines >= 500) {
                if (logBox.firstChild) {
                    logBox.removeChild(logBox.firstChild);
                }
                logBoxLines = 500;
            }

            // Auto-scroll if user is near bottom
            if (isNearBottom(logBox)) {
                logBox.scrollTop = logBox.scrollHeight;
            }
        }

        function connectLogSocket(logId) {
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const url = `${protocol}://${window.location.host}/ws/logs/${logId}`;

            let ws;

            function connect() {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    console.log(`Connected to log stream ${logId}`);
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    appendLog(data.line);
                };

                ws.onclose = (event) => {
                    console.warn(`Disconnected from log stream ${logId}, retrying in 2s...`);
                    setTimeout(connect, 2000);
                };

                ws.onerror = (err) => {
                    console.error("WebSocket error:", err);
                    ws.close();
                };
            }

            connect();
        }

        // Show/hide Jump button based on scroll
        logBox.addEventListener("scroll", () => {
            if (isNearBottom(logBox)) {
                jumpBtn.style.display = "none";
            } else {
                jumpBtn.style.display = "block";
            }
        });

        // Button action (with smooth scrolling)
        jumpBtn.addEventListener("click", () => {
            logBox.scrollTo({top: logBox.scrollHeight, behavior: "smooth"});
        });

        connectLogSocket({{ object.id }});
    </script>
{% endblock %}